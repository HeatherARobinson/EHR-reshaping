load ("sir.data.rda")
sir.data$crea<-ifelse(sir.data$ReadCode=="44J3.",as.numeric(sir.data$CodeValue),NA)

#Any non numeric values are marked NA
sir.data$DataSource<-1
sir.data$Source<-"SIR"
memory.size(40000)

library(rgdal)
library(rgeos)
library(tidyverse)
library(stringr)
library(raster)
library(spatialEco)
library(plyr)
library(dplyr)


####################################################
#DATA CLEANING
#REMOVE DUPLICATE AND OUT OF RANGE CREATININE ENTRIES
sir.data$identifier <- paste(sir.data$PatientID,sir.data$EntryDate, sir.data$CodeValue,sep="_")
which(duplicated(sir.data$identifier)) -> duplicates
sir.data[-duplicates,] -> sir.data  
sir.data$crea<-ifelse(sir.data$crea<18,NA,sir.data$CodeValue)  # creatinine values less than 18 considered not valid


#SELECT PATIENTS OVER 18
require(lubridate) 
sir.data$Age<-(as.numeric(year(strptime(sir.data$EntryDate, format="%Y%m%d"))))-sir.data$BirthYear
attach(sir.data)
sir.data<-sir.data[sir.data$Age>=18,] # remove data from minors


#CODE ETHNICITY
ethnic.data<-read.table("ethnic.data.csv",header=TRUE,sep=",")
ethnic.data$Category<-floor(ethnic.data$Category)
sir.data<-merge(sir.data,ethnic.data,by.x="Ethnicity",by.y="ClinCode2",all=FALSE)

#SELECT PATIENTS WITH CREATININE DATA
sir.data[sir.data$ReadCode=="44J3."&sir.data$ReadCode==,]->crea 
crea<-na.omit(crea)

#LIMIT TO PATIENTS WITH A MINIMUM OF 3 POST 1990 CREATININE TEST VALUES
ninety<-crea[as.numeric(year(strptime(crea$EntryDate, format="%Y%m%d")))>=1990,]
table(ninety$PatientID) < 3 -> rare  
rownames(as.matrix(rare)) -> ids

table(rare)
crea[-which(crea$PatientID %in% ids[rare]),] -> crea.rep	#Contains only people with at least three entries


#FILTER PATIENTS WHICH HAVE A RECORDED TIME RANGE FEWER THAN 4 YEARS
aggregate(crea.rep$Age, list(crea.rep$PatientID), range) -> ranges

ranges$x[,2] - ranges$x[,1] -> ranges$range

ranges[(which(ranges$range < 4)),1] -> range_short_ids    # min range - here 4

crea.rep[-which(crea.rep$PatientID %in% range_short_ids),] -> crea.rep 

sir.data<-sir.data[which(sir.data$PatientID %in% crea.rep$PatientID),]
colnames(sir.data)[5] <- "Date"

#CODE IMD
IMD.data<-read.table("IMD2015.csv",header=TRUE,sep=",")
sir.data<-merge(sir.data,IMD.data,by="LSOA",all=FALSE)

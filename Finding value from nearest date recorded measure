library(data.table)
sir.data$Blood_Urea_Nitrogen<- ifelse(sir.data$ReadCode  %in%  BloodUreaNitrogen1.csv$ReadCode,paste(sir.data$CodeValue),NA) 
smalltab<- sir.data[!is.na(sir.data$Blood_Urea_Nitrogen),]
smalltab<-smalltab[,c("PatientID","Blood_Urea_Nitrogen","EntryDate")]
smalltab<-smalltab[!is.na(smalltab$Blood_Urea_Nitrogen),]
setDT(P)
setDT(smalltab)
smalltab<-smalltab[,c("PatientID","Blood_Urea_Nitrogen", "EntryDate")]
setkey(smalltab, PatientID, EntryDate)[, dateMatch:= EntryDate]
sir.data<-smalltab[sir.data, roll='nearest']
summary(sir.data$dateMatch)
colnames(sir.data)[which(names(sir.data) == "dateMatch")] <- "BUNDate"
colnames(sir.data)[which(names(sir.data) == "i.EntryDate")] <- "EntryDate"

#Get date difference in months between value and nearest measurement
library(zoo)
datediffs<-(as.yearmon(strptime(sir.data$BUNDate, format = "%Y%m%d"))-
as.yearmon(strptime(sir.data$EntryDate, format = "%Y%m%d")))*12
datediffs<-if (datediffs< 0)
{
	datediffs = abs(datediffs);
}
sir.data$BUNoutofrange<-as.numeric(ifelse(datediffs>12,1,0))
save(sir.data, file = "sir.data")

